# Use CUDA 12.4, which is modern, well-supported by PyTorch, and works with Blackwell GPUs
FROM nvidia/cuda:12.4.1-devel-ubuntu22.04

# Set environment variables to avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies: Python 3, pip, git, and other utilities
RUN apt-get update && apt-get install -y \
    python3 \
    python3-dev \
    python3-venv \
    python3-pip \
    git \
    wget \
    build-essential \
    sed \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user with UID/GID 1000
RUN useradd -m -u 1000 -s /bin/bash appuser

# --- FIX FOR PIP VERSION ---
# Upgrade pip to the latest version BEFORE using flags it might not have
RUN python3 -m pip install --upgrade pip

# Copy all our locally downloaded sources into the image
COPY sources /opt/sources

# Create and activate a Python virtual environment for ComfyUI
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip in the virtual environment
RUN pip install --upgrade pip

# --- INSTALL PYTORCH IN THE VENV ---
# Install PyTorch into the VIRTUAL ENVIRONMENT from our local cache
RUN pip install --no-index --find-links /opt/sources/pip-packages torch torchvision torchaudio

# --- CRITICAL DEBUGGING STEP ---
# Verify PyTorch installation in the virtual environment
RUN python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA version: {torch.version.cuda}'); print(f'Device Name: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"N/A\"}')"

# Copy the application source code from our local cache
COPY sources/ComfyUI /opt/ComfyUI
COPY sources/ComfyUI-Manager /opt/ComfyUI/custom_nodes/ComfyUI-Manager
COPY sources/SageAttention /opt/SageAttention

# Set working directory to SageAttention for installation
WORKDIR /opt/SageAttention

# Set optional environment variables for parallel compilation of SageAttention
ENV EXT_PARALLEL=4
ENV NVCC_APPEND_FLAGS="--threads 8"
ENV MAX_JOBS=32

# --- THE PRAGMATIC FIX FOR GPU ARCHITECTURE ---
# Specify a compatible, modern GPU architecture that the CUDA 12.4 toolkit supports.
# '8.9' is for Ada Lovelace (RTX 40 series) and is a great modern fallback.
# This will run perfectly on your RTX 5070 Ti.
ENV TORCH_CUDA_ARCH_LIST="8.9 8.6 8.0"

# --- FIX FOR THE 'packaging' MODULE ---
# Install the 'packaging' module, which is a build-time dependency for SageAttention.
RUN /opt/venv/bin/pip install --no-index --find-links /opt/sources/pip-packages packaging

# --- FIX FOR THE 'wheel' and 'ninja' MODULES ---
# Install 'wheel' and 'ninja' directly from PyPI to get the correct versions for Python 3.10.
RUN /opt/venv/bin/pip install wheel ninja

# --- THE BYPASS FIX FOR GPU DETECTION ---
# Replace the problematic 'raise RuntimeError' line with a 'pass' statement.
RUN sed -i '81s/.*/    pass/' /opt/SageAttention/setup.py

# Install SageAttention from source.
RUN /opt/venv/bin/pip install --no-build-isolation --find-links /opt/sources/pip-packages -e .

# Return to ComfyUI directory as the primary working directory
WORKDIR /opt/ComfyUI

# Install ComfyUI's Python dependencies from our local cache
RUN /opt/venv/bin/pip install --no-index --find-links /opt/sources/pip-packages -r requirements.txt

# --- CRITICAL OWNERSHIP FIX ---
# Set the correct ownership for the application and virtual environment directories
# for the non-root user. This must be done BEFORE switching to the user.
RUN chown -R appuser:appuser /opt/ComfyUI
RUN chown -R appuser:appuser /opt/venv

# Switch to the non-root user
USER appuser

# Expose the default ComfyUI port
EXPOSE 8188

# Copy the startup script into the container
COPY startup.sh /usr/local/bin/

# Set the default command to run our startup script
CMD ["/usr/local/bin/startup.sh"]

